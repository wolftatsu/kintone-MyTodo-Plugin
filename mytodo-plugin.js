// Generated by CoffeeScript 1.7.1
(function() {
  var interval, listPage, loadCSS, modules, setDetailPageAction, timeout, waitRequirejsLoaded;

  timeout = 10 * 1000;

  interval = 100;

  modules = ['//dl.dropboxusercontent.com/u/92165755/js/shortcut.js', '//dl.dropboxusercontent.com/u/92165755/js/util.js'];

  waitRequirejsLoaded = function(callback) {
    var perform;
    perform = function() {
      timeout -= interval;
      if (typeof require !== 'undefined') {
        console.log('perform');
        require.config({
          baseUrl: '//dl.dropboxusercontent.com/u/92165755/js',
          paths: {
            jquery: 'jquery.min'
          }
        });
        return callback();
      } else if (timeout > 0) {
        return waitRequirejsLoaded();
      } else {
        return console.log('abort');
      }
    };
    return setTimeout(perform, interval);
  };

  loadCSS = function(href) {
    return document.write('<link rel="stylesheet" type="text/css" href="' + href + '" />');
  };

  setDetailPageAction = function() {
    return require(modules, function() {
      var $mydate, getNowTime;
      $mydate = $('div#record-gaia').find('div.input-date-cybozu input');
      $mydate.focus();
      getNowTime = function() {
        return dateFormat(new Date, '%h:%m') + " " + (new Date().getHours() > 12 ? "PM" : "AM");
      };
      shortcut.add("Ctrl+Alt+D", function() {
        return $(':focus').val(dateFormat(new Date, '%y-%M-%d'));
      });
      return shortcut.add("Ctrl+Alt+T", function() {
        return $(':focus').val(getNowTime());
      });
    });
  };

  listPage = function() {
    return require(modules, function() {
      var $dig, $icon, contents, el;
      shortcut.add("Ctrl+Alt+N", function() {
        return $($(".select-cybozu")[0]).find("div[role='button']").focus();
      });
      console.log('list page');
      el = kintone.app.getHeaderMenuSpaceElement();
      $icon = $('<img>').attr('src', '//dl.dropboxusercontent.com/u/92165755/img/button-doc.png');
      $icon.css({
        width: '20px',
        height: '20px',
        position: 'relative',
        top: '5px',
        cursor: 'pointer'
      });
      $(el).append($icon);
      $dig = $('<div>').attr({
        'id': 'dialog',
        'title': '日報'
      });
      contents = "<span class='report-text'></span>";
      $(contents).appendTo($dig);
      $dig.appendTo("body");
      return $icon.on("click", function() {
        var condition;
        console.log("new button clicked");
        condition = kintone.app.getQueryCondition();
        console.log(condition);
        return kintone.api('/k/v1/records', 'GET', {
          app: kintone.app.getId(),
          query: condition
        }, function(res) {
          var k, report, task, text, v, work, _i, _j, _len, _len1, _ref;
          console.log(res);
          report = {};
          text = "";
          _ref = res.records;
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            task = _ref[_i];
            console.log(task);
            if (!(task['project'].value in report)) {
              report[task['project'].value] = [];
            }
            report[task['project'].value].push(task['task'].value);
          }
          console.log(report);
          for (k in report) {
            v = report[k];
            text = "" + text + "\r\n[" + k + "]<br>";
            for (_j = 0, _len1 = v.length; _j < _len1; _j++) {
              work = v[_j];
              text = "" + text + "・" + work + "<br>";
            }
          }
          $("#dialog").dialog();
          return $(".report-text").html("<p>" + text + "</p>");
        });
      });
    });
  };

  kintone.events.on('app.record.create.show', function(event) {
    return waitRequirejsLoaded(setDetailPageAction);
  });

  kintone.events.on('app.record.edit.show', function(event) {
    console.log("edit page");
    return waitRequirejsLoaded(setDetailPageAction);
  });

  kintone.events.on('app.record.index.show', function(event) {
    console.log("index page");
    return waitRequirejsLoaded(listPage);
  });

  loadCSS('//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css');

}).call(this);
